<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Forward Pass Memory Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #2c3e50;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .demo-controls {
            text-align: center;
            margin-bottom: 30px;
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
        }
        
        .demo-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 0 10px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .demo-button:hover {
            background: #2980b9;
        }
        
        .demo-button.active {
            background: #e74c3c;
        }
        
        .view {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .memory-layout {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            min-height: 400px;
        }
        
        .memory-block {
            display: inline-block;
            border: 2px solid #333;
            margin: 2px;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            vertical-align: top;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .memory-block:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .memory-block.highlight {
            background: #e74c3c !important;
            color: white;
            animation: pulse 1s infinite;
            z-index: 5;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Component colors */
        .encoded { background: #3498db; color: white; }
        .ln1 { background: #e67e22; color: white; }
        .qkv { background: #9b59b6; color: white; }
        .att { background: #f39c12; color: white; }
        .ln2 { background: #27ae60; color: white; }
        .mlp { background: #e74c3c; color: white; }
        
        .layer-label {
            position: absolute;
            background: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        
        .explanation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .processing-sequence {
            background: #f0f8ff;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #e74c3c;
            color: white;
        }
        
        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .cache-problem {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .cache-solution {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .distance-indicator {
            position: absolute;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .distance-indicator.show {
            opacity: 1;
        }
        
        .cache-line {
            border: 2px solid #333;
            background: white;
            margin: 2px 0;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .cache-line.fetching {
            background: #3498db;
            color: white;
            animation: fetch 2s ease-in-out;
        }
        
        .cache-line.evicted {
            background: #e74c3c;
            color: white;
            animation: evict 1s ease-out;
        }
        
        .cache-line.wasted {
            background: #f39c12;
            color: white;
            text-decoration: line-through;
        }
        
        @keyframes fetch {
            0% { transform: translateX(-100px); opacity: 0; }
            50% { transform: translateX(0); opacity: 1; background: #e67e22; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes evict {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.3; }
        }
        
        .dram-block {
            border: 3px solid #e74c3c;
            background: #fff5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
        }
        
        .cache-block {
            border: 3px solid #27ae60;
            background: #f0fff4;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
            min-height: 120px;
        }
        
        .data-chunk {
            display: inline-block;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 5px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 10px;
            transition: all 0.3s ease;
        }
        
        .data-chunk.needed {
            background: #d4edda;
            border-color: #27ae60;
            font-weight: bold;
        }
        
        .data-chunk.waste {
            background: #f8d7da;
            border-color: #e74c3c;
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .fetch-arrow {
            position: absolute;
            font-size: 24px;
            color: #3498db;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .config-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† GPT-2 Memory Layout: Forward Pass Only</h1>
        
        <div class="demo-controls">
            <h3 style="color: white; margin-top: 0;">Simple Memory Layout Demo:</h3>
            <button class="demo-button active" onclick="showView('layout')">1. Andrej's Memory Layout</button>
            <button class="demo-button" onclick="showView('forward')">2. Forward Pass Problem</button>
            <button class="demo-button" onclick="showView('cache')">3. Cache Line Simulation</button>
            <button class="demo-button" onclick="showView('solution')">4. Layer-wise Solution</button>
        </div>
        
        <!-- View 1: Memory Layout -->
        <div id="layout" class="view active">
            <h2>üìã Andrej's Actual Memory Layout</h2>
            
            <div class="config-info">
                Config: 3 layers, batch_size=2, seq_len=4, channels=768<br>
                From malloc_and_point_activations() - all activations in one contiguous block
            </div>
            
            <div class="memory-layout">
                <div style="margin-bottom: 15px; font-weight: bold; color: #2c3e50;">
                    acts_memory: Contiguous block, but organized by tensor type (NOT by layer)
                </div>
                
                <!-- Encoded block -->
                <div style="border: 2px dashed #333; padding: 10px; margin: 5px 0; background: rgba(52, 152, 219, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">encoded (B√óT√óC):</div>
                    <div class="memory-block encoded" style="width: 80px; height: 30px; line-height: 26px;">
                        encoded<br>all batches
                    </div>
                </div>
                
                <!-- ln1 block - ALL layers together -->
                <div style="border: 2px dashed #e67e22; padding: 10px; margin: 5px 0; background: rgba(230, 126, 34, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">ln1 (L√óB√óT√óC) - All layers contiguous:</div>
                    <div class="memory-block ln1" id="ln1-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln1" id="ln1-l1" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln1" id="ln1-l2" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- qkv block - ALL layers together -->
                <div style="border: 2px dashed #9b59b6; padding: 10px; margin: 5px 0; background: rgba(155, 89, 182, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">qkv (L√óB√óT√ó3C) - All layers contiguous:</div>
                    <div class="memory-block qkv" id="qkv-l0" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L0]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block qkv" id="qkv-l1" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L1]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block qkv" id="qkv-l2" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L2]<br>B√óT√ó3C
                    </div>
                </div>
                
                <!-- atty block - ALL layers together -->
                <div style="border: 2px dashed #f39c12; padding: 10px; margin: 5px 0; background: rgba(243, 156, 18, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">atty (L√óB√óT√óC) - All layers contiguous:</div>
                    <div class="memory-block att" id="atty-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        atty[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block att" id="atty-l1" style="width: 50px; height: 30px; line-height: 26px;">
                        atty[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block att" id="atty-l2" style="width: 50px; height: 30px; line-height: 26px;">
                        atty[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- ln2 block - ALL layers together -->
                <div style="border: 2px dashed #27ae60; padding: 10px; margin: 5px 0; background: rgba(39, 174, 96, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">ln2 (L√óB√óT√óC) - All layers contiguous:</div>
                    <div class="memory-block ln2" id="ln2-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" id="ln2-l1" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" id="ln2-l2" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- fch block - ALL layers together -->
                <div style="border: 2px dashed #e74c3c; padding: 10px; margin: 5px 0; background: rgba(231, 76, 60, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">fch (L√óB√óT√ó4C) - All layers contiguous:</div>
                    <div class="memory-block mlp" id="fch-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        fch[L0]<br>B√óT√ó4C
                    </div>
                    <div class="memory-block mlp" id="fch-l1" style="width: 50px; height: 30px; line-height: 26px;">
                        fch[L1]<br>B√óT√ó4C
                    </div>
                    <div class="memory-block mlp" id="fch-l2" style="width: 50px; height: 30px; line-height: 26px;">
                        fch[L2]<br>B√óT√ó4C
                    </div>
                </div>
                
                <!-- Memory addresses -->
                <div style="position: absolute; bottom: 20px; left: 20px; font-family: monospace; font-size: 12px; color: #666;">
                    Memory: 0x200000000 ‚Üí 0x205000000 (5MB total, components separated by ~800KB)
                </div>
            </div>
            
            <div class="explanation">
                <h4>üîç Andrej's Actual Approach:</h4>
                <ul>
                    <li><strong>Grouped by tensor type:</strong> All ln1 together, all qkv together, etc.</li>
                    <li><strong>Within each type:</strong> Layers are contiguous (ln1[L0], ln1[L1], ln1[L2])</li>
                    <li><strong>Between types:</strong> Large gaps (ln1 block ‚Üí qkv block = ~800KB jump)</li>
                    <li><strong>Looks organized</strong> but doesn't match how we process layers!</li>
                </ul>
            </div>
        </div>
        
        <!-- View 2: Forward Pass Problem -->
        <div id="forward" class="view">
            <h2>‚è≠Ô∏è Forward Pass: Processing Layer 0</h2>
            
            <div class="memory-layout" id="forwardLayout">
                <div style="margin-bottom: 15px; font-weight: bold; color: #2c3e50;">
                    When processing Layer 0, we need to access scattered memory locations:
                </div>
                
                <!-- Show the same layout but highlight Layer 0 elements -->
                
                <!-- Encoded block -->
                <div style="border: 2px dashed #333; padding: 10px; margin: 5px 0; background: rgba(52, 152, 219, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">encoded:</div>
                    <div class="memory-block encoded" id="f-encoded" style="width: 80px; height: 30px; line-height: 26px;">
                        encoded<br>all batches
                    </div>
                </div>
                
                <!-- ln1 block - highlight L0 -->
                <div style="border: 2px dashed #e67e22; padding: 10px; margin: 5px 0; background: rgba(230, 126, 34, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">ln1 block (~800KB from encoded):</div>
                    <div class="memory-block ln1" id="f-ln1-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln1" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        ln1[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln1" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        ln1[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- qkv block - highlight L0 -->
                <div style="border: 2px dashed #9b59b6; padding: 10px; margin: 5px 0; background: rgba(155, 89, 182, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">qkv block (~1.2MB from ln1):</div>
                    <div class="memory-block qkv" id="f-qkv-l0" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L0]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block qkv" style="width: 60px; height: 30px; line-height: 26px; opacity: 0.3;">
                        qkv[L1]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block qkv" style="width: 60px; height: 30px; line-height: 26px; opacity: 0.3;">
                        qkv[L2]<br>B√óT√ó3C
                    </div>
                </div>
                
                <!-- atty block - highlight L0 -->
                <div style="border: 2px dashed #f39c12; padding: 10px; margin: 5px 0; background: rgba(243, 156, 18, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">atty block (~800KB from qkv):</div>
                    <div class="memory-block att" id="f-atty-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        atty[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block att" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        atty[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block att" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        atty[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- ln2 block - highlight L0 -->
                <div style="border: 2px dashed #27ae60; padding: 10px; margin: 5px 0; background: rgba(39, 174, 96, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">ln2 block (~600KB from atty):</div>
                    <div class="memory-block ln2" id="f-ln2-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        ln2[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        ln2[L2]<br>B√óT√óC
                    </div>
                </div>
                
                <!-- fch block - highlight L0 -->
                <div style="border: 2px dashed #e74c3c; padding: 10px; margin: 5px 0; background: rgba(231, 76, 60, 0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">fch block (~1.6MB from ln2):</div>
                    <div class="memory-block mlp" id="f-fch-l0" style="width: 50px; height: 30px; line-height: 26px;">
                        fch[L0]<br>B√óT√ó4C
                    </div>
                    <div class="memory-block mlp" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        fch[L1]<br>B√óT√ó4C
                    </div>
                    <div class="memory-block mlp" style="width: 50px; height: 30px; line-height: 26px; opacity: 0.3;">
                        fch[L2]<br>B√óT√ó4C
                    </div>
                </div>
            </div>
            
            <div class="processing-sequence">
                <h4>Layer 0 Forward Pass Sequence (click to animate):</h4>
                <button onclick="animateForwardPass()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    ‚ñ∂Ô∏è Animate Forward Pass
                </button>
                <div class="step" id="step1">
                    <div class="step-number">1</div>
                    Read encoded input embeddings
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    LayerNorm: Jump 800KB to ln1 block, access ln1[L0] - <span style="color: #e74c3c;">Cache miss!</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    QKV: Jump 1.2MB to qkv block, access qkv[L0] - <span style="color: #e74c3c;">Cache miss!</span>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    Attention: Jump 800KB to atty block, access atty[L0] - <span style="color: #e74c3c;">Cache miss!</span>
                </div>
                <div class="step" id="step5">
                    <div class="step-number">5</div>
                    LayerNorm2: Jump 600KB to ln2 block, access ln2[L0] - <span style="color: #e74c3c;">Cache miss!</span>
                </div>
                <div class="step" id="step6">
                    <div class="step-number">6</div>
                    MLP: Jump 1.6MB to fch block, access fch[L0] - <span style="color: #e74c3c;">Cache miss!</span>
                </div>
            </div>
            
            <div class="cache-problem">
                <h4>üö® The Cache Problem:</h4>
                <p><strong>Processing Layer 0 requires jumping between 6 different memory regions!</strong></p>
                <ul>
                    <li>encoded ‚Üí ln1[L0]: Jump 800KB</li>
                    <li>ln1[L0] ‚Üí qkv[L0]: Jump 1.2MB</li>
                    <li>qkv[L0] ‚Üí atty[L0]: Jump 800KB</li>
                    <li>atty[L0] ‚Üí ln2[L0]: Jump 600KB</li>
                    <li>ln2[L0] ‚Üí fch[L0]: Jump 1.6MB</li>
                </ul>
                <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>Result: Every access causes cache miss - CPU waits for memory!</strong>
                </div>
            </div>
        </div>
        
        <!-- View 3: Cache Line Simulation -->
        <div id="cache" class="view">
            <h2>üíæ Cache Line Simulation: Why Scattered Data Hurts</h2>
            
            <div class="explanation">
                <h4>üìñ How CPU Cache Works:</h4>
                <ul>
                    <li><strong>Cache Line Size:</strong> 64 bytes - CPU always fetches 64-byte chunks from DRAM</li>
                    <li><strong>When you need 1 byte:</strong> CPU fetches entire 64-byte cache line containing that byte</li>
                    <li><strong>Cache Size:</strong> L1 = 32KB, L2 = 1MB, L3 = 64MB (much smaller than DRAM)</li>
                    <li><strong>Eviction:</strong> When cache is full, old data gets thrown away to make room</li>
                </ul>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- DRAM Section -->
                <div class="dram-block">
                    <h4 style="margin-top: 0; color: #e74c3c;">üñ•Ô∏è DRAM (Scattered Layout)</h4>
                    <div style="margin-bottom: 10px; font-size: 12px;">
                        Each row = 64-byte cache line
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 5px; margin: 5px 0; background: rgba(52, 152, 219, 0.1);">
                        <strong>encoded block:</strong><br>
                        <div class="data-chunk needed" id="encoded-chunk">encoded</div>
                        <div class="data-chunk waste">unused</div>
                        <div class="data-chunk waste">unused</div>
                        <div class="data-chunk waste">unused</div>
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 5px; margin: 15px 0; background: rgba(230, 126, 34, 0.1);">
                        <strong>ln1 block (+800KB away):</strong><br>
                        <div class="data-chunk waste">ln1[L2]</div>
                        <div class="data-chunk waste">ln1[L1]</div>
                        <div class="data-chunk needed" id="ln1-chunk">ln1[L0]</div>
                        <div class="data-chunk waste">unused</div>
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 5px; margin: 15px 0; background: rgba(155, 89, 182, 0.1);">
                        <strong>qkv block (+1.2MB away):</strong><br>
                        <div class="data-chunk waste">qkv[L2]</div>
                        <div class="data-chunk needed" id="qkv-chunk">qkv[L0]</div>
                        <div class="data-chunk waste">qkv[L1]</div>
                        <div class="data-chunk waste">unused</div>
                    </div>
                </div>
                
                <!-- Cache Section -->
                <div class="cache-block">
                    <h4 style="margin-top: 0; color: #27ae60;">‚ö° L1 Cache (32KB only)</h4>
                    <div style="margin-bottom: 10px; font-size: 12px;">
                        What gets loaded when accessing scattered data:
                    </div>
                    
                    <div class="cache-line" id="cache-line-1">
                        <strong>Cache Line 1:</strong> 
                        <span class="data-chunk needed">encoded</span>
                        <span class="data-chunk waste">+3 unused chunks</span>
                        <div style="font-size: 10px; color: #666;">‚úÖ We needed 'encoded', got 75% waste</div>
                    </div>
                    
                    <div class="cache-line" id="cache-line-2">
                        <strong>Cache Line 2:</strong>
                        <span class="data-chunk waste">ln1[L2]</span>
                        <span class="data-chunk waste">ln1[L1]</span>
                        <span class="data-chunk needed">ln1[L0]</span>
                        <span class="data-chunk waste">unused</span>
                        <div style="font-size: 10px; color: #666;">‚úÖ We needed 'ln1[L0]', got 75% waste</div>
                    </div>
                    
                    <div class="cache-line" id="cache-line-3">
                        <strong>Cache Line 3:</strong>
                        <span class="data-chunk waste">qkv[L2]</span>
                        <span class="data-chunk needed">qkv[L0]</span>
                        <span class="data-chunk waste">qkv[L1]</span>
                        <span class="data-chunk waste">unused</span>
                        <div style="font-size: 10px; color: #666;">‚úÖ We needed 'qkv[L0]', got 75% waste</div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">
                        <strong>Cache Full!</strong> Next access will evict old data...
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="simulateCacheAccess()" style="background: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                    ‚ñ∂Ô∏è Simulate Cache Access Pattern
                </button>
            </div>
            
            <div class="cache-problem">
                <h4>üö® The Cache Waste Problem:</h4>
                <ul>
                    <li><strong>Scattered Layout:</strong> Layer 0 data spread across different cache lines</li>
                    <li><strong>Cache Line Waste:</strong> Each 64-byte fetch gets mostly irrelevant data</li>
                    <li><strong>Eviction Pressure:</strong> Cache fills up with useless data from other layers</li>
                    <li><strong>Repeated Fetches:</strong> Same data evicted and re-fetched multiple times</li>
                </ul>
                <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>Result: 75% of cache bandwidth wasted on irrelevant data!</strong>
                </div>
            </div>
            
            <div class="cache-solution">
                <h4>‚úÖ How Contiguous Layout Fixes This:</h4>
                <div style="background: #f0fff4; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <strong>If Layer 0 data was contiguous:</strong><br>
                    <div class="data-chunk needed">encoded</div>
                    <div class="data-chunk needed">ln1[L0]</div>
                    <div class="data-chunk needed">qkv[L0]</div>
                    <div class="data-chunk needed">atty[L0]</div>
                    <br>
                    <strong>Single cache line = all data we need! 100% efficiency!</strong>
                </div>
            </div>
        </div>
        
        <!-- View 4: Solution (renumbered) -->
        <div id="solution" class="view">
            <h2>‚úÖ Layer-wise Memory Layout Solution</h2>
            
            <div class="memory-layout">
                <div style="margin-bottom: 15px; font-weight: bold; color: #2c3e50;">
                    Optimized: Group all data for each layer together
                </div>
                
                <!-- Layer 0 block -->
                <div class="optimized-block">
                    <div style="font-weight: bold; margin-bottom: 5px; color: #27ae60;">Layer 0 Block (contiguous):</div>
                    <div class="memory-block encoded" style="width: 60px; height: 30px; line-height: 26px;">
                        encoded<br>B√óT√óC
                    </div>
                    <div class="memory-block ln1" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block qkv" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L0]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block att" style="width: 50px; height: 30px; line-height: 26px;">
                        att[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L0]<br>B√óT√óC
                    </div>
                    <div class="memory-block mlp" style="width: 50px; height: 30px; line-height: 26px;">
                        mlp[L0]<br>B√óT√ó4C
                    </div>
                </div>
                
                <!-- Layer 1 block -->
                <div class="optimized-block">
                    <div style="font-weight: bold; margin-bottom: 5px; color: #27ae60;">Layer 1 Block (contiguous):</div>
                    <div class="memory-block ln1" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block qkv" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L1]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block att" style="width: 50px; height: 30px; line-height: 26px;">
                        att[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L1]<br>B√óT√óC
                    </div>
                    <div class="memory-block mlp" style="width: 50px; height: 30px; line-height: 26px;">
                        mlp[L1]<br>B√óT√ó4C
                    </div>
                </div>
                
                <!-- Layer 2 block -->
                <div class="optimized-block">
                    <div style="font-weight: bold; margin-bottom: 5px; color: #27ae60;">Layer 2 Block (contiguous):</div>
                    <div class="memory-block ln1" style="width: 50px; height: 30px; line-height: 26px;">
                        ln1[L2]<br>B√óT√óC
                    </div>
                    <div class="memory-block qkv" style="width: 60px; height: 30px; line-height: 26px;">
                        qkv[L2]<br>B√óT√ó3C
                    </div>
                    <div class="memory-block att" style="width: 50px; height: 30px; line-height: 26px;">
                        att[L2]<br>B√óT√óC
                    </div>
                    <div class="memory-block ln2" style="width: 50px; height: 30px; line-height: 26px;">
                        ln2[L2]<br>B√óT√óC
                    </div>
                    <div class="memory-block mlp" style="width: 50px; height: 30px; line-height: 26px;">
                        mlp[L2]<br>B√óT√ó4C
                    </div>
                </div>
            </div>
            
            <div class="cache-solution">
                <h4>üöÄ Why This Works Better:</h4>
                <p><strong>Sequential Layer Processing + Contiguous Layer Memory = Cache Friendly</strong></p>
                <ul>
                    <li><strong>Perfect Match:</strong> We process layers sequentially, so store them sequentially</li>
                    <li><strong>Cache Locality:</strong> All data for Layer 0 fits in same cache lines</li>
                    <li><strong>Sequential Access:</strong> encoded ‚Üí ln1 ‚Üí qkv ‚Üí att ‚Üí ln2 ‚Üí mlp (no jumps!)</li>
                    <li><strong>Prefetch Friendly:</strong> Hardware can predict access pattern</li>
                </ul>
                <div style="background: #27ae60; color: white; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>Result: Cache hit rate ~92%, CPU spends time computing instead of waiting!</strong>
                </div>
            </div>
            
            <div class="explanation">
                <h4>üí° Key Insight:</h4>
                <p><strong>Match memory layout to computation pattern!</strong></p>
                <p>Since we process layers sequentially (L0 ‚Üí L1 ‚Üí L2), we should store them sequentially too. This ensures that when we're working on Layer 0, all its data is in nearby memory locations that fit in cache together.</p>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'layout';
        let animationInterval;
        
        function simulateCacheAccess() {
            // Reset all states
            document.querySelectorAll('.cache-line').forEach(el => {
                el.classList.remove('fetching', 'evicted');
            });
            document.querySelectorAll('.data-chunk').forEach(el => {
                el.classList.remove('needed', 'waste');
            });
            
            // Simulate sequence of accesses
            setTimeout(() => {
                // Access 1: encoded
                document.getElementById('cache-line-1').classList.add('fetching');
                document.getElementById('encoded-chunk').classList.add('needed');
                
                setTimeout(() => {
                    // Access 2: ln1[L0] - far away, evicts encoded cache line
                    document.getElementById('cache-line-1').classList.add('evicted');
                    document.getElementById('cache-line-2').classList.add('fetching');
                    document.getElementById('ln1-chunk').classList.add('needed');
                    
                    setTimeout(() => {
                        // Access 3: qkv[L0] - far away, evicts ln1 cache line
                        document.getElementById('cache-line-2').classList.add('evicted');
                        document.getElementById('cache-line-3').classList.add('fetching');
                        document.getElementById('qkv-chunk').classList.add('needed');
                        
                        setTimeout(() => {
                            // Show the waste
                            document.querySelectorAll('.data-chunk').forEach(el => {
                                if (!el.classList.contains('needed')) {
                                    el.classList.add('waste');
                                }
                            });
                        }, 1000);
                    }, 1500);
                }, 1500);
            }, 500);
        }
        
        function showView(view) {
            // Clear animations
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            
            // Hide current view
            document.getElementById(currentView).classList.remove('active');
            document.querySelector(`[onclick="showView('${currentView}')"]`).classList.remove('active');
            
            // Show new view
            document.getElementById(view).classList.add('active');
            document.querySelector(`[onclick="showView('${view}')"]`).classList.add('active');
            
            currentView = view;
        }
        
        function showView(view) {
            // Clear animations
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            
            // Hide current view
            document.getElementById(currentView).classList.remove('active');
            document.querySelector(`[onclick="showView('${currentView}')"]`).classList.remove('active');
            
            // Show new view
            document.getElementById(view).classList.add('active');
            document.querySelector(`[onclick="showView('${view}')"]`).classList.add('active');
            
            currentView = view;
            
            // Start animation for forward pass
            if (view === 'forward') {
                setTimeout(animateForwardPass, 500);
            }
        }
        
        function animateForwardPass() {
            const elements = ['f-encoded', 'f-ln1-l0', 'f-qkv-l0', 'f-atty-l0', 'f-ln2-l0', 'f-fch-l0'];
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6'];
            
            let currentStep = 0;
            
            // Clear any existing animation
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            
            animationInterval = setInterval(() => {
                // Clear previous highlights
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('highlight');
                });
                steps.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('active');
                });
                
                // Highlight current step
                if (currentStep < elements.length) {
                    const el = document.getElementById(elements[currentStep]);
                    const stepEl = document.getElementById(steps[currentStep]);
                    if (el) el.classList.add('highlight');
                    if (stepEl) stepEl.classList.add('active');
                }
                
                currentStep++;
                if (currentStep > elements.length) {
                    clearInterval(animationInterval);
                    // Clear all highlights after animation
                    setTimeout(() => {
                        elements.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.classList.remove('highlight');
                        });
                        steps.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.classList.remove('active');
                        });
                    }, 1000);
                }
            }, 1200);
        }
        
        // Remove auto-demo - only manual control now
        // Removed startAutoDemo function and setTimeout call
    </script>
</body>
</html>