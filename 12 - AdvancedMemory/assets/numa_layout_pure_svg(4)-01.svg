<svg id="a7847e6c-589e-4b83-870b-574904c7d5d1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 495.43"><text transform="translate(341.96 30)" style="isolation:isolate;font-size:20px;fill:#4caf50;font-family:CourierNewPS-BoldMT, Courier New;font-weight:700">NUMA Strategy: Layout vs Runtime Separation</text><rect x="50" y="60" width="1100" height="180" rx="8" style="fill:#2c2c54;stroke:#40407a;stroke-width:2px"/><text transform="translate(70 85)" style="isolation:isolate;font-size:16px;fill:#ffc107;font-family:CourierNewPS-BoldMT, Courier New;font-weight:700">1. Layout Phase: Simple Global Offsets (Your Current Code Unchanged)</text><rect x="80" y="100" width="150" height="30" style="fill:#3742fa;stroke:#fff"/><text transform="translate(121.99 120)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">LN Weights</text><text transform="translate(128 145)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">offset: 0</text><rect x="250" y="100" width="150" height="30" style="fill:#3742fa;stroke:#fff"/><text transform="translate(288.69 120)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">QKV Weights</text><text transform="translate(288.99 145)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">offset: 1024</text><rect x="420" y="100" width="200" height="30" style="fill:#9c27b0;stroke:#fff"/><text transform="translate(440.79 120)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">Layer Input (All Tokens)</text><text transform="translate(480.99 145)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">offset: 50000</text><rect x="640" y="100" width="200" height="30" style="fill:#9c27b0;stroke:#fff"/><text transform="translate(664.09 120)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">MLP Output (All Tokens)</text><text transform="translate(697.99 145)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">offset: 150000</text><path d="M853.78,100h275.7a3.9,3.9,0,0,1,3.78,4v82a3.9,3.9,0,0,1-3.78,4H853.78a3.89,3.89,0,0,1-3.78-4V104A3.89,3.89,0,0,1,853.78,100Z" style="fill:#1a1a2e;stroke:#40407a"/><text transform="translate(860 120)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Color Legend:</text><rect x="860" y="125" width="15" height="10" style="fill:#3742fa"/><text transform="translate(880 134)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Shared Weights</text><rect x="860" y="140" width="15" height="10" style="fill:#4caf50"/><text transform="translate(880 149)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">NUMA Node 0</text><rect x="860" y="155" width="15" height="10" style="fill:#ff9800"/><text transform="translate(880 164)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">NUMA Node 1</text><rect x="1000" y="125" width="15" height="10" style="fill:#9c27b0"/><text transform="translate(1020 134)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">NUMA Node 2</text><rect x="1000" y="140" width="15" height="10" style="fill:#f44336"/><text transform="translate(1020 149)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">NUMA Node 3</text><rect x="1000" y="155" width="15" height="10" style="fill:#ffc107"/><text transform="translate(1020 164)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Attention Heads</text><text transform="translate(80 165)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">L-&gt;ln1_weight_offset = bump(&amp;off, embed_dim, CACHE_ALIGN);</text><text transform="translate(80 180)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">L-&gt;layer_input_offset = bump(&amp;off, context_window * embed_dim, CACHE_ALIGN);</text><text transform="translate(80 195)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">L-&gt;mlp_output_offset = bump(&amp;off, context_window * embed_dim, CACHE_ALIGN);</text><text transform="translate(600 215)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:ArialMT, Arial">✅<tspan x="7.5" y="0" xml:space="preserve" style="font-family:CourierNewPSMT, Courier New"> Simple O(L) complexity, same as your current code</tspan></text><text transform="translate(80 225)" style="isolation:isolate;font-size:10px;fill:#2196f3;font-family:CourierNewPSMT, Courier New">All offsets virtual → identical for every thread</text><rect x="50" y="260" width="1100" height="220" rx="8" style="fill:#2c2c54;stroke:#40407a;stroke-width:2px"/><text transform="translate(70 285)" style="isolation:isolate;font-size:16px;fill:#ffc107;font-family:CourierNewPS-BoldMT, Courier New;font-weight:700">2. Runtime Phase: NUMA Arenas + Thread Assignment</text><rect x="80" y="310" width="250" height="130" rx="4" style="fill:#4caf50;fill-opacity:0.20000000298023224;stroke:#4caf50;stroke-width:2px"/><text transform="translate(85 325)" style="isolation:isolate;font-size:11px;fill:#4caf50;font-family:CourierNewPSMT, Courier New">NUMA Node 0 (Cores 0-7)</text><rect x="90" y="330" width="60" height="20" style="fill:#4caf50"/><text transform="translate(94.8 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">T 0-999</text><rect x="160" y="330" width="60" height="20" style="fill:#4caf50"/><text transform="translate(172 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">H 0-7</text><rect x="230" y="330" width="60" height="20" style="fill:#4caf50"/><text transform="translate(245.6 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">MLP<tspan x="21.6" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">₀</tspan></text><text transform="translate(90 365)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">scratch_base[0] = mmap(...)</text><text transform="translate(90 380)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">mbind(..., MPOL_BIND, node_0_mask)</text><text transform="translate(90 395)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">pthread_setaffinity(cores 0-7)</text><text transform="translate(90 410)" style="isolation:isolate;font-size:11px;fill:#4caf50;font-family:CourierNewPSMT, Courier New">ptr = scratch_base[0] + offset</text><rect x="350" y="310" width="250" height="130" rx="4" style="fill:#ff9800;fill-opacity:0.20000000298023224;stroke:#ff9800;stroke-width:2px"/><text transform="translate(355 325)" style="isolation:isolate;font-size:11px;fill:#ff9800;font-family:CourierNewPSMT, Courier New">NUMA Node 1 (Cores 8-15)</text><rect x="360" y="330" width="70" height="30.62" style="fill:#ff9800"/><text transform="translate(373.33 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">T 1000-<tspan x="0" y="14.4">1999</tspan></text><rect x="440" y="330" width="60" height="20" style="fill:#ff9800"/><text transform="translate(448.4 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">H 8-15</text><rect x="510" y="330" width="60" height="20" style="fill:#ff9800"/><text transform="translate(525.6 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">MLP<tspan x="21.6" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">₁</tspan></text><rect x="620" y="310" width="250" height="130" rx="4" style="fill:#9c27b0;fill-opacity:0.20000000298023224;stroke:#9c27b0;stroke-width:2px"/><text transform="translate(625 325)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">NUMA Node 2 (Cores 16-23)</text><rect x="630" y="330" width="70" height="30.96" style="fill:#9c27b0"/><text transform="translate(640 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">T 2000<tspan x="0" y="14.4">-2999</tspan></text><rect x="710" y="330" width="60" height="20" style="fill:#9c27b0"/><text transform="translate(714.8 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">H 16-23</text><rect x="780" y="330" width="60" height="20" style="fill:#9c27b0"/><text transform="translate(795.6 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">MLP<tspan x="21.6" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">₂</tspan></text><rect x="890" y="310" width="250" height="130" rx="4" style="fill:#f44336;fill-opacity:0.20000000298023224;stroke:#f44336;stroke-width:2px"/><text transform="translate(895 325)" style="isolation:isolate;font-size:11px;fill:#f44336;font-family:CourierNewPSMT, Courier New">NUMA Node 3 (Cores 24-31)</text><rect x="900" y="330" width="70" height="30.96" style="fill:#f44336"/><text transform="translate(912.35 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">T 3000<tspan x="0" y="14.4">-3999</tspan></text><rect x="980" y="330" width="60" height="20" style="fill:#f44336"/><text transform="translate(984.8 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">H 24-31</text><rect x="1050" y="330" width="60" height="20" style="fill:#f44336"/><text transform="translate(1065.6 343)" style="isolation:isolate;font-size:12px;fill:#fff;font-family:CourierNewPSMT, Courier New">MLP<tspan x="21.6" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">₃</tspan></text><line x1="562.11" y1="241.13" x2="562.11" y2="301.67" style="fill:none;stroke:#ffc107;stroke-width:2px"/><path d="M562.11,300.86c2.09-2.09,6.22-3.08,9.09-3.17a27.25,27.25,0,0,0-9.09,11.1c-1.81-4.51-5.37-8.07-9.09-11.1C556.09,297.94,559.81,298.69,562.11,300.86Z" style="fill:#ffc107"/><text transform="translate(570 274.5)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Same global offsets,</text><text transform="translate(570 289.5)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">different physical memory</text></svg>