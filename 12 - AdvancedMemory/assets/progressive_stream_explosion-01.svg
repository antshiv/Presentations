<svg id="ad8936e3-9133-45e6-9443-05334f992237" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1400 674.21"><defs><linearGradient id="f953c05a-7c22-49ad-afdc-77b44ff30f7d" x1="-258.6" y1="1139.83" x2="-257.6" y2="1139.83" gradientTransform="matrix(650, 0, 0, -180, 168141, 205480)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fff3e0"/><stop offset="1" stop-color="#e74c3c" stop-opacity="0.8"/></linearGradient><linearGradient id="a3a8146f-e1bd-4986-bf31-06e1ca8ec979" x1="-258.59" y1="1139.6" x2="-257.59" y2="1139.6" gradientTransform="matrix(630, 0, 0, -580, 163631, 661340)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#e8f5e8"/><stop offset="1" stop-color="#27ae60" stop-opacity="0.3"/></linearGradient></defs><text transform="translate(355.88 30)" style="isolation:isolate;font-size:24px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Progressive Stream Explosion: Why QKV Breaks Everything</text><text transform="translate(417.25 55)" style="isolation:isolate;font-size:16px;fill:#7f8c8d;font-family:Arial-BoldMT, Arial;font-weight:700">How Each Operation<tspan x="156.47" y="0" style="letter-spacing:-0.037109375em"> </tspan><tspan x="160.32" y="0">Adds Memory Streams in Karpathy&apos;s Layout</tspan></text><rect x="50" y="80" width="650" height="120" style="fill:#f8f9fa;stroke:#6c757d;stroke-width:2px"/><text transform="translate(70 105)" style="isolation:isolate;font-size:18px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 1: LayerNorm - Manageable (3 streams)</text><g id="f9b41746-b5d2-406a-bf93-7c896b8362c8" data-name="layernorm-streams"><text transform="translate(70 130)" style="isolation:isolate;font-size:14px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Active Memory Streams:</text><rect x="70" y="140" width="80" height="25" style="fill:#bbdefb;stroke:#3498db;stroke-width:2px"/><text transform="translate(81.26 157)" style="isolation:isolate;font-size:11px;font-family:ArialMT, Arial">Input[B,<tspan x="37.91" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="43.41" y="0">,C]</tspan></text><rect x="160" y="140" width="60" height="25" style="fill:#ffcdd2;stroke:#e74c3c;stroke-width:2px"/><text transform="translate(180.22 157)" style="isolation:isolate;font-size:11px;font-family:ArialMT, Arial">Î³[C]</text><rect x="230" y="140" width="60" height="25" style="fill:#ffcdd2;stroke:#e74c3c;stroke-width:2px"/><text transform="translate(249.81 157)" style="isolation:isolate;font-size:11px;font-family:ArialMT, Arial">Î²[C]</text><rect x="350" y="135" width="320" height="35" style="fill:#d5f4e6;stroke:#27ae60"/><text transform="translate(360 155)" style="isolation:isolate;font-size:12px;fill:#2e7d32;font-family:ArialMT, Arial">Stream<tspan x="38.68" y="0" style="letter-spacing:-0.01806640625em"> </tspan><tspan x="41.79" y="0" style="letter-spacing:-0.037109375em">T</tspan><tspan x="48.68" y="0">racker: 3/4 slots used - Still manageable </tspan><tspan x="265.45" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">âœ“</tspan></text></g><rect x="70" y="175" width="600" height="20" style="fill:#ecf0f1;stroke:#bdc3c7"/><text transform="translate(80 188)" style="isolation:isolate;font-size:10px;fill:#2c3e50;font-family:CourierNewPSMT, Courier New">out[i] = (input[i] - mean) * rstd * gamma[i] + beta[i];</text><rect x="50" y="220" width="650" height="180" style="stroke:#e74c3c;stroke-width:3px;fill:url(#f953c05a-7c22-49ad-afdc-77b44ff30f7d)"/><text transform="translate(70 245)" style="isolation:isolate;font-size:18px;fill:#c0392b;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 2: QKV<tspan x="114.03" y="0" style="letter-spacing:-0.037109375em"> </tspan><tspan x="118.36" y="0">Attention - STREAM EXPLOSION! (6-8 streams)</tspan></text><g id="aefc2181-6683-4d11-9ac3-8b8c00ee2425" data-name="qkv-streams"><text transform="translate(70 270)" style="isolation:isolate;font-size:14px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Active Memory Streams:</text><rect x="70" y="280" width="70" height="20" style="fill:#bbdefb;stroke:#3498db"/><text transform="translate(81.49 293)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Input[B,<tspan x="31.02" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="35.52" y="0">,C]</tspan></text><rect x="150" y="280" width="80" height="20" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(166 293)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Wqkv[3C,C]</text><rect x="240" y="280" width="60" height="20" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(251.74 293)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Bqkv[3C]</text><rect x="70" y="310" width="50" height="20" style="fill:#e1f5fe;stroke:#0277bd"/><text transform="translate(78 323)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Q[B,<tspan x="18" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="22.5" y="0">,C]</tspan></text><rect x="130" y="310" width="50" height="20" style="fill:#e8f5e8;stroke:#388e3c"/><text transform="translate(138.5 323)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">K[B,<tspan x="17.01" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="21.51" y="0">,C]</tspan></text><rect x="190" y="310" width="50" height="20" style="fill:#fce4ec;stroke:#c2185b"/><text transform="translate(198.5 323)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">V[B,<tspan x="17.01" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="21.51" y="0">,C]</tspan></text><rect x="250" y="310" width="70" height="20" style="fill:#f3e5f5;stroke:#7b1fa2"/><text transform="translate(253.49 323)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Scores[B,H,<tspan x="48.01" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="52.51" y="0">,T]</tspan></text><rect x="330" y="310" width="60" height="20" style="fill:#e0f2f1;stroke:#00695c"/><text transform="translate(334.49 323)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Attn[B,H,<tspan x="36.01" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="40.51" y="0">,T]</tspan></text><rect x="400" y="280" width="270" height="50" style="fill:#ffebee;stroke:#e74c3c;stroke-width:2px"/><text transform="translate(410 300)" style="isolation:isolate;font-size:12px;fill:#c62828;font-family:MyriadPro-Regular, Myriad Pro">âš ï¸<tspan x="6" y="0" xml:space="preserve" style="font-family:Arial-BoldMT, Arial;font-weight:700"> Stream </tspan><tspan x="53.36" y="0" style="font-family:Arial-BoldMT, Arial;font-weight:700;letter-spacing:-0.05517578125em">T</tspan><tspan x="60.02" y="0" style="font-family:Arial-BoldMT, Arial;font-weight:700">racker: 8/4 slots - OVERLOADED!</tspan></text><text transform="translate(410 318)" style="isolation:isolate;font-size:11px;fill:#d32f2f;font-family:ArialMT, Arial">Streams being evicted every few cache lines</text></g><rect x="70" y="340" width="600" height="50" style="fill:#ffcdd2;stroke:#e74c3c"/><text transform="translate(80 375)" style="isolation:isolate;font-size:11px;fill:#d32f2f;font-family:ArialMT, Arial">CPU rapidly switches: Input â†’ Wqkv â†’ Q_out â†’ K_out â†’ V_out â†’ Scores â†’<tspan x="383.31" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="385.76" y="0">Attention weights</tspan></text><text transform="translate(80 385)" style="isolation:isolate;font-size:11px;fill:#d32f2f;font-family:ArialMT, Arial">Stream tracker can&apos;t keep up - prefetcher confidence collapses to ~30%</text><rect x="50" y="420" width="650" height="100" style="fill:#fff8e1;stroke:#ff9800;stroke-width:2px"/><text transform="translate(70 445)" style="isolation:isolate;font-size:18px;fill:#ef6c00;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 3:<tspan x="70.02" y="0" style="letter-spacing:-0.037109375em"> </tspan><tspan x="74.36" y="0">Attention Projection - Still Bad (4 streams)</tspan></text><g id="a64a65a3-b399-4579-9e25-ef792062b163" data-name="proj-streams"><text transform="translate(70 470)" style="isolation:isolate;font-size:14px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Active Memory Streams:</text><rect x="70" y="480" width="80" height="20" style="fill:#e1f5fe;stroke:#0277bd"/><text transform="translate(79.73 493)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Attn_out[B,<tspan x="44.53" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="49.03" y="0">,C]</tspan></text><rect x="160" y="480" width="60" height="20" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(168 493)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Wproj[C,C]</text><rect x="230" y="480" width="50" height="20" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(238.74 493)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Bproj[C]</text><rect x="290" y="480" width="60" height="20" style="fill:#bbdefb;stroke:#3498db"/><text transform="translate(292.99 493)" style="isolation:isolate;font-size:9px;font-family:ArialMT, Arial">Output[B,<tspan x="38.02" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="42.52" y="0">,C]</tspan></text><rect x="400" y="475" width="250" height="30" style="fill:#ffe0b2;stroke:#f57c00"/><text transform="translate(410 495)" style="isolation:isolate;font-size:11px;fill:#ef6c00;font-family:ArialMT, Arial">Stream<tspan x="35.45" y="0" style="letter-spacing:-0.01806640625em"> </tspan><tspan x="38.31" y="0" style="letter-spacing:-0.037109375em">T</tspan><tspan x="44.62" y="0">racker: Still overloaded, patterns broken</tspan></text></g><rect x="50" y="540" width="650" height="120" style="fill:#ffebee;stroke:#e74c3c;stroke-width:2px"/><text transform="translate(70 565)" style="isolation:isolate;font-size:18px;fill:#c62828;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 4: MLP/FC - The Final Straw (5-6 streams)</text><g id="a38af68b-018d-4eb9-a54d-9332c80d8d18" data-name="mlp-streams"><text transform="translate(70 590)" style="isolation:isolate;font-size:14px;fill:#2c3e50;font-family:Arial-BoldMT, Arial;font-weight:700">Active Memory Streams:</text><rect x="70" y="600" width="60" height="18" style="fill:#bbdefb;stroke:#3498db"/><text transform="translate(79.1 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">Input[B,<tspan x="27.57" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="31.57" y="0">,C]</tspan></text><rect x="140" y="600" width="60" height="18" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(152.66 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">W1[C,4C]</text><rect x="210" y="600" width="50" height="18" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(222.77 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">B1[4C]</text><rect x="270" y="600" width="60" height="18" style="fill:#f3e5f5;stroke:#7b1fa2"/><text transform="translate(274.88 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">GELU[B,<tspan x="31.57" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="35.57" y="0">,4C]</tspan></text><rect x="340" y="600" width="60" height="18" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(352.66 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">W2[4C,C]</text><rect x="410" y="600" width="50" height="18" style="fill:#fff3e0;stroke:#ff9800"/><text transform="translate(425 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">B2[C]</text><rect x="470" y="600" width="60" height="18" style="fill:#bbdefb;stroke:#3498db"/><text transform="translate(475.99 612)" style="isolation:isolate;font-size:8px;font-family:ArialMT, Arial">Output[B,<tspan x="33.8" y="0" style="letter-spacing:-0.11083984375em">T</tspan><tspan x="37.8" y="0">,C]</tspan></text><rect x="70" y="625" width="600" height="25" style="fill:#ffcdd2;stroke:#e74c3c"/></g><text transform="translate(75.13 641.13)" style="font-size:11px;fill:#d32f2f;font-family:ArialMT, Arial">ğŸ’€<tspan x="8.25" y="0" xml:space="preserve" style="letter-spacing:-0.01806640625em"> T</tspan><tspan x="17.63" y="0">O</tspan><tspan x="26.18" y="0" style="letter-spacing:-0.07421875em">T</tspan><tspan x="32.09" y="0">A</tspan><tspan x="39.42" y="0" style="letter-spacing:-0.037109375em">L</tspan><tspan x="45.13" y="0" xml:space="preserve"> DISASTER: 12+ concurrent streams across all operations - Hardware prefetcher gives up</tspan></text><rect x="720" y="80" width="630" height="580" style="stroke:#27ae60;stroke-width:3px;fill:url(#a3a8146f-e1bd-4986-bf31-06e1ca8ec979)"/><g id="f6c5376c-ceb5-4e81-a250-b39f6b590d57" data-name="optimized-stages"><rect x="740" y="120" width="590" height="80" style="fill:#e8f5e8;stroke:#4caf50"/><text transform="translate(750 140)" style="isolation:isolate;font-size:14px;fill:#2e7d32;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 1: LayerNorm (Sequential)</text><text transform="translate(750 160)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase<tspan x="31.19" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="33.64" y="0">A: Process all Î³[0..C] â†’ One stream</tspan></text><text transform="translate(750 175)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase B: Process all Î²[0..C] â†’ One stream</text><text transform="translate(750 190)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Result: Perfect prefetching, 95% hit rate <tspan x="197.49" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">âœ“</tspan></text><rect x="740" y="210" width="590" height="100" style="fill:#e8f5e8;stroke:#4caf50"/><text transform="translate(750 230)" style="isolation:isolate;font-size:14px;fill:#2e7d32;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 2: QKV (Blocked Processing)</text><text transform="translate(750 250)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase<tspan x="31.19" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="33.64" y="0">A:</tspan><tspan x="44.03" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="46.48" y="0">All Wqkv weights for current tile â†’ One stream</tspan></text><text transform="translate(750 265)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase B:<tspan x="44.64" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="47.09" y="0">All input data for current tile â†’ One stream</tspan></text><text transform="translate(750 280)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase C: Compute Q,K,V outputs sequentially â†’ One stream</text><text transform="translate(750 295)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Result: 2-3 streams max, perfect prediction <tspan x="212.75" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">âœ“</tspan></text><rect x="740" y="320" width="590" height="80" style="fill:#e8f5e8;stroke:#4caf50"/><text transform="translate(750 340)" style="isolation:isolate;font-size:14px;fill:#2e7d32;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 3: Projection (<tspan x="135.36" y="0" style="letter-spacing:-0.01806640625em">T</tspan><tspan x="143.66" y="0">iled)</tspan></text><text transform="translate(750 360)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase<tspan x="31.19" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="33.64" y="0">A:</tspan><tspan x="44.03" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="46.48" y="0">All projection weights â†’ One stream</tspan></text><text transform="translate(750 375)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase B:<tspan x="44.64" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="47.09" y="0">All attention outputs â†’ One stream</tspan></text><text transform="translate(750 390)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Result: Perfect sequential access <tspan x="165.69" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">âœ“</tspan></text><rect x="740" y="410" width="590" height="100" style="fill:#e8f5e8;stroke:#4caf50"/><text transform="translate(750 430)" style="isolation:isolate;font-size:14px;fill:#2e7d32;font-family:Arial-BoldMT, Arial;font-weight:700">Stage 4: ML<tspan x="78.57" y="0" style="letter-spacing:-0.01806640625em">P</tspan><tspan x="87.65" y="0" xml:space="preserve"> (Staged)</tspan></text><text transform="translate(750 450)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase<tspan x="31.19" y="0" style="letter-spacing:-0.05517578125em"> </tspan><tspan x="33.64" y="0">A: FC1 weights + input â†’</tspan><tspan x="158.67" y="0" style="letter-spacing:-0.01806640625em"> </tspan><tspan x="161.52" y="0" style="letter-spacing:-0.05517578125em">T</tspan><tspan x="167.64" y="0">wo streams</tspan></text><text transform="translate(750 465)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase B: GELU activation â†’ One stream</text><text transform="translate(750 480)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Phase C: FC2 weights + intermediate â†’<tspan x="196.56" y="0" style="letter-spacing:-0.01806640625em"> </tspan><tspan x="199.42" y="0" style="letter-spacing:-0.05517578125em">T</tspan><tspan x="205.53" y="0">wo streams</tspan></text><text transform="translate(750 495)" style="isolation:isolate;font-size:11px;fill:#388e3c;font-family:ArialMT, Arial">Result: Max 2 streams per phase <tspan x="164.46" y="0" style="font-family:MyriadPro-Regular, Myriad Pro">âœ“</tspan></text><rect x="740" y="520" width="590" height="130" style="fill:#d4edda;stroke:#28a745;stroke-width:2px"/><text transform="translate(750 570)" style="isolation:isolate;font-size:13px;fill:#155724;font-family:ArialMT, Arial">â€¢ Stream<tspan x="50.06" y="0" style="letter-spacing:-0.01806640625em"> </tspan><tspan x="53.44" y="0" style="letter-spacing:-0.037109375em">T</tspan><tspan x="60.9" y="0">racker: Never overloaded (1-2 active streams)</tspan></text><text transform="translate(750 590)" style="isolation:isolate;font-size:13px;fill:#155724;font-family:ArialMT, Arial">â€¢ Prefetcher Confidence: 95%+ (perfect patterns)</text><text transform="translate(750 610)" style="isolation:isolate;font-size:13px;fill:#155724;font-family:ArialMT, Arial">â€¢ Cache Hit Rate: L1=90%, L2=97%</text><text transform="translate(750 630)" style="isolation:isolate;font-size:13px;fill:#155724;font-family:Arial-BoldMT, Arial;font-weight:700">â€¢ Performance: 3-5x faster than Karpathy</text></g></svg>