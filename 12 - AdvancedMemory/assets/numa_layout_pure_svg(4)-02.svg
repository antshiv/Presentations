<svg id="a5458f77-2566-40c2-ab72-dad2ce6aee2b" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 327.83"><rect x="50" y="20.91" width="550" height="180" rx="8" style="fill:#2c2c54;stroke:#40407a;stroke-width:2px"/><text transform="translate(70 45.91)" style="isolation:isolate;font-size:16px;fill:#ffc107;font-family:CourierNewPS-BoldMT, Courier New;font-weight:700">3. Cache Line Padding Problem</text><text transform="translate(70 70.91)" style="isolation:isolate;font-size:11px;fill:#f44336;font-family:ArialMT, Arial">❌<tspan x="8.25" y="0" xml:space="preserve" style="font-family:CourierNewPSMT, Courier New"> Problem: Token boundaries cross cache lines</tspan></text><rect x="80" y="80.91" width="500" height="40" style="fill:#333;stroke:#666"/><line x1="80" y1="80.91" x2="80" y2="120.91" style="fill:none;stroke:#fff"/><line x1="144" y1="80.91" x2="144" y2="120.91" style="fill:none;stroke:#fff"/><line x1="208" y1="80.91" x2="208" y2="120.91" style="fill:none;stroke:#fff"/><line x1="272" y1="80.91" x2="272" y2="120.91" style="fill:none;stroke:#fff"/><line x1="336" y1="80.91" x2="336" y2="120.91" style="fill:none;stroke:#fff"/><line x1="400" y1="80.91" x2="400" y2="120.91" style="fill:none;stroke:#fff"/><line x1="464" y1="80.91" x2="464" y2="120.91" style="fill:none;stroke:#fff"/><line x1="528" y1="80.91" x2="528" y2="120.91" style="fill:none;stroke:#fff"/><line x1="580" y1="80.91" x2="580" y2="120.91" style="fill:none;stroke:#fff"/><rect x="80" y="85.91" width="200" height="15" style="fill:#f44336;fill-opacity:0.699999988079071"/><text transform="translate(122.99 96.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Token 0 (1000 dims)</text><rect x="280" y="85.91" width="200" height="15" style="fill:#f44336;fill-opacity:0.699999988079071"/><text transform="translate(322.99 96.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Token 1 (1000 dims)</text><rect x="270" y="100.91" width="20" height="15" style="fill:#ffc107"/><text transform="translate(259 111.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">OVERLAP</text><text transform="translate(80 140.91)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">embed_dim = 1000 → 4000 bytes per token</text><text transform="translate(80 155.91)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">4000 ÷ 64 = 62.5 cache lines per token</text><text transform="translate(80 170.91)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:ArialMT, Arial">❌<tspan x="7.5" y="0" xml:space="preserve" style="font-family:CourierNewPSMT, Courier New"> Token boundaries are NOT cache-aligned!</tspan></text><text transform="translate(80 185.91)" style="isolation:isolate;font-size:10px;fill:#2196f3;font-family:CourierNewPSMT, Courier New">CL = 64 B (cache line size)</text><rect x="620" y="20.91" width="530" height="180" rx="8" style="fill:#2c2c54;stroke:#40407a;stroke-width:2px"/><text transform="translate(640 45.91)" style="isolation:isolate;font-size:16px;fill:#ffc107;font-family:CourierNewPS-BoldMT, Courier New;font-weight:700">4. Solution: Pad Tokens to Cache Lines</text><text transform="translate(640 70.91)" style="isolation:isolate;font-size:11px;fill:#4caf50;font-family:ArialMT, Arial">✅<tspan x="8.25" y="0" xml:space="preserve" style="font-family:CourierNewPSMT, Courier New"> Solution: Pad each token to 64-byte boundary</tspan></text><rect x="650" y="80.91" width="480" height="40" style="fill:#333;stroke:#666"/><line x1="650" y1="80.91" x2="650" y2="120.91" style="fill:none;stroke:#fff"/><line x1="714" y1="80.91" x2="714" y2="120.91" style="fill:none;stroke:#fff"/><line x1="778" y1="80.91" x2="778" y2="120.91" style="fill:none;stroke:#fff"/><line x1="842" y1="80.91" x2="842" y2="120.91" style="fill:none;stroke:#fff"/><line x1="906" y1="80.91" x2="906" y2="120.91" style="fill:none;stroke:#fff"/><line x1="970" y1="80.91" x2="970" y2="120.91" style="fill:none;stroke:#fff"/><line x1="1034" y1="80.91" x2="1034" y2="120.91" style="fill:none;stroke:#fff"/><line x1="1098" y1="80.91" x2="1098" y2="120.91" style="fill:none;stroke:#fff"/><line x1="1130" y1="80.91" x2="1130" y2="120.91" style="fill:none;stroke:#fff"/><rect x="650" y="85.91" width="128" height="15" style="fill:#4caf50;fill-opacity:0.699999988079071"/><text transform="translate(665.99 96.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Token 0 (padded)</text><rect x="778" y="85.91" width="128" height="15" style="fill:#4caf50;fill-opacity:0.699999988079071"/><text transform="translate(793.99 96.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Token 1 (padded)</text><rect x="906" y="85.91" width="128" height="15" style="fill:#4caf50;fill-opacity:0.699999988079071"/><text transform="translate(921.99 96.92)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Token 2 (padded)</text><text transform="translate(640 140.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">padded = align_up(embed_dim * 4, 64) / 4; // bytes → floats</text><text transform="translate(640 155.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">L-&gt;layer_input_offset = bump(&amp;off, context_window * padded, CACHE_ALIGN);</text><text transform="translate(640 170.91)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:ArialMT, Arial">✅<tspan x="7.5" y="0" xml:space="preserve" style="font-family:CourierNewPSMT, Courier New"> Each token owns complete cache lines</tspan></text><text transform="translate(640 185.91)" style="isolation:isolate;font-size:10px;fill:#ccc;font-family:CourierNewPSMT, Courier New">Memory overhead: ~2-5% for perfect isolation</text><rect x="50" y="220.91" width="1100" height="90" rx="8" style="fill:#1e3a8a;stroke:#3b82f6;stroke-width:2px"/><text transform="translate(80 270.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">1. layout_transformer() → Global offsets (O(L) complexity, simple)</text><text transform="translate(80 285.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">2. Runtime setup → NUMA arenas + thread assignment (separate concern)</text><text transform="translate(600 270.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">3. Optional padding → Eliminate cache line sharing (if needed)</text><text transform="translate(600 285.91)" style="isolation:isolate;font-size:11px;fill:#e8f5e8;font-family:CourierNewPSMT, Courier New">4. LOCAL_PTR(node, offset) → Translate global offset to local pointer</text><text transform="translate(80 300.91)" style="isolation:isolate;font-size:10px;fill:#2196f3;font-family:CourierNewPSMT, Courier New">Note: Huge pages and mbind() done AFTER layout</text></svg>