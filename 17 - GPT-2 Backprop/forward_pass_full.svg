<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1600">
  <defs>
    <linearGradient id="grad-input" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#4a90e2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#357abd;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-embed" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#81c784;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#66bb6a;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-layer" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ffd54f;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffb300;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-attention" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ba68c8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#9c27b0;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-mlp" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#e57373;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#d32f2f;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="grad-output" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ff6f00;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#e65100;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#888" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="40" font-size="32" font-weight="bold" fill="#f0f0f0" text-anchor="middle">GPT-2 Forward Pass</text>
  <text x="600" y="70" font-size="16" fill="#aaa" text-anchor="middle">Token-by-Token Inference Through 6 Transformer Layers</text>

  <!-- Input Tokens -->
  <rect x="450" y="100" width="300" height="60" rx="10" fill="url(#grad-input)" stroke="#357abd" stroke-width="2"/>
  <text x="600" y="125" font-size="14" font-weight="bold" fill="white" text-anchor="middle">Input Tokens</text>
  <text x="600" y="145" font-size="12" fill="white" text-anchor="middle">[T=1024] Token IDs</text>

  <!-- Arrow -->
  <line x1="600" y1="160" x2="600" y2="190" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

  <!-- Token + Positional Embeddings -->
  <rect x="400" y="200" width="400" height="80" rx="10" fill="url(#grad-embed)" stroke="#66bb6a" stroke-width="2"/>
  <text x="600" y="225" font-size="14" font-weight="bold" fill="white" text-anchor="middle">Embedding Layer</text>
  <text x="600" y="245" font-size="11" fill="white" text-anchor="middle">Token Emb [50257 × 1536] + Pos Emb [1024 × 1536]</text>
  <text x="600" y="265" font-size="12" fill="#e0f7e0" text-anchor="middle">Output: [T × D] = [1024 × 1536]</text>

  <!-- Arrow -->
  <line x1="600" y1="280" x2="600" y2="310" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

  <!-- Layer Block (repeated structure) -->
  <g id="layer-block">
    <!-- Layer Container -->
    <rect x="150" y="320" width="900" height="480" rx="10" fill="#2a2a2a" stroke="#444" stroke-width="2"/>
    <text x="600" y="345" font-size="16" font-weight="bold" fill="#ff6f00" text-anchor="middle">Transformer Layer (×6)</text>

    <!-- Input marker -->
    <text x="600" y="370" font-size="11" font-weight="bold" fill="#4ade80" text-anchor="middle">Input (x)</text>
    <line x1="600" y1="375" x2="600" y2="395" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- ============ BLOCK 1: Attention + Residual 1 ============ -->

    <!-- Split point for Skip 1 -->
    <circle cx="600" cy="395" r="5" fill="#4ade80"/>

    <!-- Main path: LayerNorm 1 -->
    <rect x="530" y="405" width="140" height="45" rx="8" fill="#3d3d3d" stroke="#666" stroke-width="2"/>
    <text x="600" y="423" font-size="11" fill="#ccc" text-anchor="middle">LayerNorm 1</text>
    <text x="600" y="438" font-size="9" fill="#888" text-anchor="middle">[T × D]</text>

    <!-- Arrow down -->
    <line x1="600" y1="450" x2="600" y2="470" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- Multi-Head Attention -->
    <rect x="530" y="475" width="140" height="50" rx="8" fill="url(#grad-attention)" stroke="#9c27b0" stroke-width="2"/>
    <text x="600" y="495" font-size="12" font-weight="bold" fill="white" text-anchor="middle">Multi-Head Attn</text>
    <text x="600" y="512" font-size="10" fill="white" text-anchor="middle">Q, K, V → 8 heads</text>

    <!-- Arrow to ADD 1 -->
    <line x1="600" y1="525" x2="600" y2="545" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- Skip 1: Bypass LN1 + Attention -->
    <path d="M 600 395 L 180 395 L 180 555 L 580 555" stroke="#4ade80" stroke-width="3" fill="none" stroke-dasharray="8,4"/>
    <text x="175" y="470" font-size="11" font-weight="bold" fill="#4ade80" text-anchor="end">Skip 1</text>
    <text x="175" y="485" font-size="9" fill="#4ade80" text-anchor="end">(bypass LN+Attn)</text>

    <!-- ADD 1 circle -->
    <circle cx="600" cy="555" r="20" fill="#4ade80" stroke="#2a2a2a" stroke-width="2"/>
    <text x="600" y="562" font-size="22" font-weight="bold" fill="#2a2a2a" text-anchor="middle">+</text>
    <text x="680" y="560" font-size="11" fill="#4ade80">x + Attn(LN(x))</text>

    <!-- Arrow down from ADD 1 to Split 2 -->
    <line x1="600" y1="575" x2="600" y2="595" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- ============ BLOCK 2: MLP + Residual 2 ============ -->

    <!-- Split point for Skip 2 -->
    <circle cx="600" cy="595" r="5" fill="#4ade80"/>

    <!-- Main path: LayerNorm 2 -->
    <rect x="530" y="605" width="140" height="45" rx="8" fill="#3d3d3d" stroke="#666" stroke-width="2"/>
    <text x="600" y="623" font-size="11" fill="#ccc" text-anchor="middle">LayerNorm 2</text>
    <text x="600" y="638" font-size="9" fill="#888" text-anchor="middle">[T × D]</text>

    <!-- Arrow down from LN2 to MLP -->
    <line x1="600" y1="650" x2="600" y2="670" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- MLP -->
    <rect x="530" y="675" width="140" height="50" rx="8" fill="url(#grad-mlp)" stroke="#d32f2f" stroke-width="2"/>
    <text x="600" y="695" font-size="12" font-weight="bold" fill="white" text-anchor="middle">MLP (FFN)</text>
    <text x="600" y="712" font-size="10" fill="white" text-anchor="middle">FC1 → GELU → FC2</text>

    <!-- Arrow from MLP to ADD 2 -->
    <line x1="600" y1="725" x2="600" y2="745" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

    <!-- Skip 2: Bypass LN2 + MLP -->
    <path d="M 600 595 L 1020 595 L 1020 755 L 620 755" stroke="#4ade80" stroke-width="3" fill="none" stroke-dasharray="8,4"/>
    <text x="1025" y="670" font-size="11" font-weight="bold" fill="#4ade80">Skip 2</text>
    <text x="1025" y="685" font-size="9" fill="#4ade80">(bypass LN+MLP)</text>

    <!-- ADD 2 circle -->
    <circle cx="600" cy="755" r="20" fill="#4ade80" stroke="#2a2a2a" stroke-width="2"/>
    <text x="600" y="762" font-size="22" font-weight="bold" fill="#2a2a2a" text-anchor="middle">+</text>
    <text x="470" y="760" font-size="11" fill="#4ade80" text-anchor="end">prev + MLP(LN(prev))</text>

    <!-- Output marker -->
    <line x1="600" y1="775" x2="600" y2="795" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>
    <text x="610" y="790" font-size="10" fill="#4ade80">Output</text>
  </g>

  <!-- Arrow after layers -->
  <line x1="600" y1="800" x2="600" y2="825" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>
  <text x="620" y="810" font-size="10" fill="#888">Repeat 6×</text>

  <!-- Final LayerNorm -->
  <rect x="450" y="835" width="300" height="60" rx="10" fill="#3d3d3d" stroke="#666" stroke-width="2"/>
  <text x="600" y="860" font-size="14" font-weight="bold" fill="#ccc" text-anchor="middle">Final LayerNorm</text>
  <text x="600" y="880" font-size="12" fill="#888" text-anchor="middle">[T × D] = [1024 × 1536]</text>

  <!-- Arrow -->
  <line x1="600" y1="895" x2="600" y2="920" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

  <!-- LM Head (Weight Tying) -->
  <rect x="400" y="930" width="400" height="80" rx="10" fill="url(#grad-output)" stroke="#e65100" stroke-width="3"/>
  <text x="600" y="955" font-size="14" font-weight="bold" fill="white" text-anchor="middle">Language Model Head</text>
  <text x="600" y="975" font-size="11" fill="white" text-anchor="middle">Linear: [D × V] = [1536 × 50257]</text>
  <text x="600" y="995" font-size="10" fill="#ffe0b2" text-anchor="middle">⚠️ Weight Tying: Shares weights with Token Embedding</text>

  <!-- Arrow -->
  <line x1="600" y1="1010" x2="600" y2="1040" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

  <!-- Output Logits -->
  <rect x="450" y="1050" width="300" height="60" rx="10" fill="url(#grad-input)" stroke="#357abd" stroke-width="2"/>
  <text x="600" y="1075" font-size="14" font-weight="bold" fill="white" text-anchor="middle">Output Logits</text>
  <text x="600" y="1095" font-size="12" fill="white" text-anchor="middle">[T × V] = [1024 × 50257]</text>

  <!-- Arrow -->
  <line x1="600" y1="1110" x2="600" y2="1140" stroke="#888" stroke-width="3" marker-end="url(#arrowhead)"/>

  <!-- Softmax -->
  <rect x="450" y="1150" width="300" height="60" rx="10" fill="#ba68c8" stroke="#9c27b0" stroke-width="2"/>
  <text x="600" y="1175" font-size="14" font-weight="bold" fill="white" text-anchor="middle">Softmax (per token)</text>
  <text x="600" y="1195" font-size="12" fill="white" text-anchor="middle">Probabilities: [T × V]</text>

  <!-- Annotations -->
  <g id="annotations">
    <!-- T annotation -->
    <text x="50" y="850" font-size="12" font-weight="bold" fill="#4ade80">T = 1024</text>
    <text x="50" y="870" font-size="10" fill="#888">Context length</text>
    <text x="50" y="885" font-size="10" fill="#888">(tokens processed</text>
    <text x="50" y="900" font-size="10" fill="#888">in parallel)</text>

    <!-- D annotation -->
    <text x="50" y="950" font-size="12" font-weight="bold" fill="#4ade80">D = 1536</text>
    <text x="50" y="970" font-size="10" fill="#888">Embedding dim</text>

    <!-- V annotation -->
    <text x="50" y="1020" font-size="12" font-weight="bold" fill="#4ade80">V = 50257</text>
    <text x="50" y="1040" font-size="10" fill="#888">Vocabulary size</text>

    <!-- H annotation -->
    <text x="1050" y="850" font-size="12" font-weight="bold" fill="#4ade80">H = 8</text>
    <text x="1050" y="870" font-size="10" fill="#888">Attention heads</text>

    <!-- Layers annotation -->
    <text x="1050" y="920" font-size="12" font-weight="bold" fill="#4ade80">Layers = 6</text>
    <text x="1050" y="940" font-size="10" fill="#888">Transformer</text>
    <text x="1050" y="955" font-size="10" fill="#888">blocks</text>
  </g>

  <!-- Data flow indicators -->
  <text x="600" y="1500" font-size="14" font-weight="bold" fill="#4ade80" text-anchor="middle">✅ Token-Parallel: Each token processed independently</text>
  <text x="600" y="1525" font-size="14" font-weight="bold" fill="#4ade80" text-anchor="middle">✅ Cache-friendly: All data in single contiguous arena</text>
  <text x="600" y="1550" font-size="14" font-weight="bold" fill="#4ade80" text-anchor="middle">✅ SIMD-optimized: AVX-512 for matrix operations</text>
</svg>
